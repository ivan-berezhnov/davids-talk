version: 2

init: &init
  docker:
    - image: docksal/ci-agent:php
  working_directory: /home/agent/build

run-envvars: &run-envvars
  name: Configuring build environment
  command: |
    echo 'source build-env' > $BASH_ENV

jobs:
  sandbox:
    <<: *init
    steps:
      - run:
          <<: *run-envvars

  build:
    <<: *init
    steps:
      - run:
          <<: *run-envvars
      - checkout
      - run:
          name: Build sandbox
          command: |
            source build-env
            sandbox-init

  deploy:
    <<: *init
    steps:
      - run:
          <<: *run-envvars
      - attach_workspace:
          at: /home/agent
      - run: echo $PRIVATE_KEY | base64 -d > /home/agent/.ssh/id_rsa
      - run:
          name: Deploying to Production
          command: |
            source build-env
            echo -e "Removing files and folders that should not be committed to Production...\n"
            build-exec "rm /home/ivo/builds/davids-talk-master/web/sites/default/settings.local.php"
            build-exec "rm -rf /home/ivo/builds/davids-talk-master/web/sites/default/files"
            build-exec "cp /home/ivo/builds/davids-talk-master/.docksal/settings/settings.prod.php  /home/ivo/builds/davids-talk-master/web/sites/default"
            build-exec "echo '${SECRET_PROD_DB}' >> /home/ivo/builds/davids-talk-master/web/sites/default/settings.prod.php"
            echo -e "Copy files to Production...\n"
            build-exec  "scp -r ${MASTER_DIR} ${SSH_ADD}"
            echo -e "Removing sandbox container and files...\n"
            build-exec "fin p remove && rm -rf ${REMOTE_BUILD_DIR}"


workflows:
  version: 2
  ivo-workflow:
    jobs:
      - build:
          context: org-ivo

      - sandbox:
          requires:
            - build
          filters:
            branches:
              ignore:
                - master

      - deploy:
          requires:
            - build
          context: org-ivo
          filters:
            branches:
              only:
                - master
